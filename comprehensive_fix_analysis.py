#!/usr/bin/env python3
"""
ä¼ªæ ‡ç­¾ç”Ÿæˆå’Œæ¨¡å‹é¢„æµ‹ç»¼åˆé—®é¢˜åˆ†æä¸ä¿®å¤å»ºè®®
"""

import pandas as pd
import numpy as np
import sys
import os
import logging

# è®¾ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
sys.path.append('.')

def analyze_pseudo_labeling_issues():
    """åˆ†æä¼ªæ ‡ç­¾ç”Ÿæˆçš„é—®é¢˜"""
    print("ğŸ” ä¼ªæ ‡ç­¾ç”Ÿæˆé—®é¢˜åˆ†æ")
    print("=" * 50)
    
    issues = {
        "å¾ªç¯å¯¼å…¥é—®é¢˜": {
            "æè¿°": "å¤šä¸ªç”Ÿæˆå™¨ä¹‹é—´å­˜åœ¨å¾ªç¯ä¾èµ–",
            "å½±å“": "å¯¼è‡´æ¨¡å—åŠ è½½å¤±è´¥æˆ–è¿è¡Œæ—¶é”™è¯¯",
            "ä½ç½®": [
                "backend/pseudo_labeling/pseudo_label_generator.py:98-108",
                "backend/pseudo_labeling/semi_supervised_generator.py:347-358"
            ],
            "ä¸¥é‡ç¨‹åº¦": "é«˜"
        },
        "ç‰¹å¾æå–ä¸ä¸€è‡´": {
            "æè¿°": "ä¸åŒç”Ÿæˆå™¨ä½¿ç”¨ä¸åŒçš„ç‰¹å¾æå–é€»è¾‘",
            "å½±å“": "æ ‡ç­¾è´¨é‡ä¸ç¨³å®šï¼Œç»“æœä¸å¯é‡ç°",
            "ä½ç½®": [
                "backend/pseudo_labeling/semi_supervised_generator.py:162-188",
                "backend/pseudo_labeling/fast_pseudo_label_generator.py:108-120"
            ],
            "ä¸¥é‡ç¨‹åº¦": "ä¸­"
        },
        "è´¨é‡è¯„ä¼°ç¼ºå¤±": {
            "æè¿°": "ç¼ºä¹æœ‰æ•ˆçš„æ ‡ç­¾è´¨é‡éªŒè¯æœºåˆ¶",
            "å½±å“": "æ— æ³•ä¿è¯ç”Ÿæˆæ ‡ç­¾çš„å¯é æ€§",
            "ä½ç½®": [
                "backend/pseudo_labeling/pseudo_label_generator.py:å…¨æ–‡",
                "backend/pseudo_labeling/fast_pseudo_label_generator.py:237-258"
            ],
            "ä¸¥é‡ç¨‹åº¦": "é«˜"
        },
        "æ€§èƒ½ç“¶é¢ˆ": {
            "æè¿°": "æ ‡å‡†æ¨¡å¼ç”Ÿæˆå™¨æ•ˆç‡ä½ä¸‹",
            "å½±å“": "å¤§æ•°æ®é›†å¤„ç†æ—¶é—´è¿‡é•¿",
            "ä½ç½®": [
                "backend/pseudo_labeling/pseudo_label_generator.py:272-295",
                "frontend/pages/pseudo_labeling_page.py:455-461"
            ],
            "ä¸¥é‡ç¨‹åº¦": "ä¸­"
        }
    }
    
    for issue_name, details in issues.items():
        print(f"\nâŒ {issue_name}")
        print(f"   æè¿°: {details['æè¿°']}")
        print(f"   å½±å“: {details['å½±å“']}")
        print(f"   ä¸¥é‡ç¨‹åº¦: {details['ä¸¥é‡ç¨‹åº¦']}")
        print(f"   ä½ç½®: {', '.join(details['ä½ç½®'])}")
    
    return issues

def analyze_model_prediction_issues():
    """åˆ†ææ¨¡å‹é¢„æµ‹çš„é—®é¢˜"""
    print("\nğŸ” æ¨¡å‹é¢„æµ‹é—®é¢˜åˆ†æ")
    print("=" * 50)
    
    issues = {
        "ç‰¹å¾å¯¹é½å¤±æ•ˆ": {
            "æè¿°": "ç‰¹å¾åç§°æ˜ å°„ä¸å®Œæ•´ï¼Œå¯¼è‡´é¢„æµ‹å¤±è´¥",
            "å½±å“": "æ¨¡å‹æ— æ³•æ­£ç¡®è¯†åˆ«è¾“å…¥ç‰¹å¾",
            "ä½ç½®": [
                "backend/ml_models/model_manager.py:170-254",
                "backend/ml_models/model_manager.py:220-254"
            ],
            "ä¸¥é‡ç¨‹åº¦": "é«˜"
        },
        "æ¨¡å‹åŠ è½½ä¸ç¨³å®š": {
            "æè¿°": "ç¼ºä¹æ¨¡å‹æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥",
            "å½±å“": "æ¨¡å‹åŠ è½½å¤±è´¥æˆ–é¢„æµ‹é”™è¯¯",
            "ä½ç½®": [
                "backend/ml_models/model_manager.py:77-117",
                "backend/ml_models/four_class_model_manager.py:292-327"
            ],
            "ä¸¥é‡ç¨‹åº¦": "é«˜"
        },
        "é¢„æµ‹ç»“æœæ ¼å¼ä¸ä¸€è‡´": {
            "æè¿°": "ä¸åŒæ¨¡å‹è¿”å›æ ¼å¼å·®å¼‚",
            "å½±å“": "ç»“æœå¤„ç†å’Œæ˜¾ç¤ºé”™è¯¯",
            "ä½ç½®": [
                "backend/ml_models/model_manager.py:154-169",
                "frontend/pages/model_prediction_page.py:714-737"
            ],
            "ä¸¥é‡ç¨‹åº¦": "ä¸­"
        },
        "é”™è¯¯å¤„ç†ä¸å……åˆ†": {
            "æè¿°": "å¼‚å¸¸æƒ…å†µä¸‹çš„å›é€€æœºåˆ¶ä¸å®Œå–„",
            "å½±å“": "ç³»ç»Ÿå´©æºƒæˆ–ç”¨æˆ·ä½“éªŒå·®",
            "ä½ç½®": [
                "backend/ml_models/model_manager.py:166-169",
                "frontend/pages/model_prediction_page.py:418-419"
            ],
            "ä¸¥é‡ç¨‹åº¦": "ä¸­"
        }
    }
    
    for issue_name, details in issues.items():
        print(f"\nâŒ {issue_name}")
        print(f"   æè¿°: {details['æè¿°']}")
        print(f"   å½±å“: {details['å½±å“']}")
        print(f"   ä¸¥é‡ç¨‹åº¦: {details['ä¸¥é‡ç¨‹åº¦']}")
        print(f"   ä½ç½®: {', '.join(details['ä½ç½®'])}")
    
    return issues

def generate_fix_recommendations():
    """ç”Ÿæˆä¿®å¤å»ºè®®"""
    print("\nğŸ’¡ ç»¼åˆä¿®å¤å»ºè®®")
    print("=" * 50)
    
    recommendations = {
        "ä¼ªæ ‡ç­¾ç”Ÿæˆä¿®å¤": [
            {
                "ä¼˜å…ˆçº§": "P0",
                "é—®é¢˜": "å¾ªç¯å¯¼å…¥",
                "è§£å†³æ–¹æ¡ˆ": "é‡æ„å¯¼å…¥ç»“æ„ï¼Œä½¿ç”¨å»¶è¿Ÿå¯¼å…¥æˆ–ä¾èµ–æ³¨å…¥",
                "å®æ–½æ­¥éª¤": [
                    "1. å°†å…±åŒä¾èµ–æå–åˆ°ç‹¬ç«‹æ¨¡å—",
                    "2. ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºç”Ÿæˆå™¨å®ä¾‹",
                    "3. åœ¨è¿è¡Œæ—¶åŠ¨æ€å¯¼å…¥ä¾èµ–æ¨¡å—"
                ]
            },
            {
                "ä¼˜å…ˆçº§": "P1",
                "é—®é¢˜": "è´¨é‡è¯„ä¼°ç¼ºå¤±",
                "è§£å†³æ–¹æ¡ˆ": "å»ºç«‹ç»Ÿä¸€çš„æ ‡ç­¾è´¨é‡è¯„ä¼°æ¡†æ¶",
                "å®æ–½æ­¥éª¤": [
                    "1. å®šä¹‰æ ‡ç­¾è´¨é‡æŒ‡æ ‡ï¼ˆä¸€è‡´æ€§ã€ç½®ä¿¡åº¦ã€åˆ†å¸ƒåˆç†æ€§ï¼‰",
                    "2. å®ç°è´¨é‡è¯„ä¼°ç®—æ³•",
                    "3. é›†æˆåˆ°æ‰€æœ‰ç”Ÿæˆå™¨ä¸­"
                ]
            },
            {
                "ä¼˜å…ˆçº§": "P2",
                "é—®é¢˜": "ç‰¹å¾æå–ä¸ä¸€è‡´",
                "è§£å†³æ–¹æ¡ˆ": "ç»Ÿä¸€ç‰¹å¾æå–æ¥å£å’Œå®ç°",
                "å®æ–½æ­¥éª¤": [
                    "1. åˆ›å»ºç»Ÿä¸€çš„ç‰¹å¾æå–å™¨åŸºç±»",
                    "2. æ ‡å‡†åŒ–ç‰¹å¾åç§°å’Œæ ¼å¼",
                    "3. é‡æ„æ‰€æœ‰ç”Ÿæˆå™¨ä½¿ç”¨ç»Ÿä¸€æ¥å£"
                ]
            }
        ],
        "æ¨¡å‹é¢„æµ‹ä¿®å¤": [
            {
                "ä¼˜å…ˆçº§": "P0",
                "é—®é¢˜": "ç‰¹å¾å¯¹é½å¤±æ•ˆ",
                "è§£å†³æ–¹æ¡ˆ": "å¢å¼ºç‰¹å¾å¯¹é½ç®—æ³•å’Œæ˜ å°„è¡¨",
                "å®æ–½æ­¥éª¤": [
                    "1. æ‰©å±•ç‰¹å¾åç§°æ˜ å°„è¡¨",
                    "2. æ·»åŠ æ¨¡ç³ŠåŒ¹é…ç®—æ³•",
                    "3. å®ç°ç‰¹å¾é‡è¦æ€§æ£€æŸ¥"
                ]
            },
            {
                "ä¼˜å…ˆçº§": "P0",
                "é—®é¢˜": "æ¨¡å‹åŠ è½½ä¸ç¨³å®š",
                "è§£å†³æ–¹æ¡ˆ": "æ·»åŠ æ¨¡å‹æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥å’ŒéªŒè¯",
                "å®æ–½æ­¥éª¤": [
                    "1. å®ç°æ¨¡å‹æ–‡ä»¶å“ˆå¸ŒéªŒè¯",
                    "2. æ·»åŠ æ¨¡å‹å…¼å®¹æ€§æ£€æŸ¥",
                    "3. å»ºç«‹æ¨¡å‹åŠ è½½é‡è¯•æœºåˆ¶"
                ]
            },
            {
                "ä¼˜å…ˆçº§": "P1",
                "é—®é¢˜": "é¢„æµ‹ç»“æœæ ¼å¼ä¸ä¸€è‡´",
                "è§£å†³æ–¹æ¡ˆ": "æ ‡å‡†åŒ–é¢„æµ‹ç»“æœæ ¼å¼å’Œå¤„ç†æµç¨‹",
                "å®æ–½æ­¥éª¤": [
                    "1. å®šä¹‰ç»Ÿä¸€çš„é¢„æµ‹ç»“æœæ•°æ®ç»“æ„",
                    "2. å®ç°ç»“æœæ ¼å¼è½¬æ¢å™¨",
                    "3. æ›´æ–°æ‰€æœ‰è°ƒç”¨æ–¹ä½¿ç”¨ç»Ÿä¸€æ ¼å¼"
                ]
            }
        ]
    }
    
    for category, fixes in recommendations.items():
        print(f"\nğŸ”§ {category}")
        for fix in fixes:
            print(f"\n   {fix['ä¼˜å…ˆçº§']} - {fix['é—®é¢˜']}")
            print(f"   è§£å†³æ–¹æ¡ˆ: {fix['è§£å†³æ–¹æ¡ˆ']}")
            print(f"   å®æ–½æ­¥éª¤:")
            for step in fix['å®æ–½æ­¥éª¤']:
                print(f"     {step}")
    
    return recommendations

def create_implementation_plan():
    """åˆ›å»ºå®æ–½è®¡åˆ’"""
    print("\nğŸ“‹ å®æ–½è®¡åˆ’")
    print("=" * 50)
    
    plan = {
        "ç¬¬ä¸€é˜¶æ®µ (ç´§æ€¥ä¿®å¤)": {
            "æ—¶é—´": "ç«‹å³æ‰§è¡Œ",
            "ä»»åŠ¡": [
                "ä¿®å¤å¾ªç¯å¯¼å…¥é—®é¢˜",
                "å¢å¼ºç‰¹å¾å¯¹é½ç®—æ³•",
                "æ·»åŠ æ¨¡å‹åŠ è½½éªŒè¯",
                "æ”¹è¿›é”™è¯¯å¤„ç†æœºåˆ¶"
            ],
            "é¢„æœŸæ•ˆæœ": "ç³»ç»ŸåŸºæœ¬åŠŸèƒ½æ­£å¸¸è¿è¡Œ"
        },
        "ç¬¬äºŒé˜¶æ®µ (è´¨é‡æå‡)": {
            "æ—¶é—´": "1-2å¤©å†…",
            "ä»»åŠ¡": [
                "å»ºç«‹æ ‡ç­¾è´¨é‡è¯„ä¼°æ¡†æ¶",
                "ç»Ÿä¸€ç‰¹å¾æå–æ¥å£",
                "æ ‡å‡†åŒ–é¢„æµ‹ç»“æœæ ¼å¼",
                "ä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆ"
            ],
            "é¢„æœŸæ•ˆæœ": "ç³»ç»Ÿç¨³å®šæ€§å’Œå‡†ç¡®æ€§æ˜¾è‘—æå‡"
        },
        "ç¬¬ä¸‰é˜¶æ®µ (é•¿æœŸä¼˜åŒ–)": {
            "æ—¶é—´": "åç»­è¿­ä»£",
            "ä»»åŠ¡": [
                "å®ç°è‡ªåŠ¨åŒ–æµ‹è¯•",
                "å»ºç«‹ç›‘æ§å’Œå‘Šè­¦",
                "ä¼˜åŒ–ç®—æ³•æ€§èƒ½",
                "æ‰©å±•åŠŸèƒ½ç‰¹æ€§"
            ],
            "é¢„æœŸæ•ˆæœ": "ç³»ç»Ÿè¾¾åˆ°ç”Ÿäº§çº§åˆ«è´¨é‡"
        }
    }
    
    for phase, details in plan.items():
        print(f"\nğŸ“… {phase}")
        print(f"   æ—¶é—´: {details['æ—¶é—´']}")
        print(f"   ä»»åŠ¡:")
        for task in details['ä»»åŠ¡']:
            print(f"     â€¢ {task}")
        print(f"   é¢„æœŸæ•ˆæœ: {details['é¢„æœŸæ•ˆæœ']}")
    
    return plan

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸš€ ä¼ªæ ‡ç­¾ç”Ÿæˆå’Œæ¨¡å‹é¢„æµ‹ç»¼åˆé—®é¢˜åˆ†æ")
    print("=" * 60)
    
    try:
        # åˆ†æé—®é¢˜
        pseudo_issues = analyze_pseudo_labeling_issues()
        model_issues = analyze_model_prediction_issues()
        
        # ç”Ÿæˆä¿®å¤å»ºè®®
        recommendations = generate_fix_recommendations()
        
        # åˆ›å»ºå®æ–½è®¡åˆ’
        plan = create_implementation_plan()
        
        # æ€»ç»“
        print("\nğŸ“Š é—®é¢˜æ€»ç»“")
        print("=" * 30)
        total_issues = len(pseudo_issues) + len(model_issues)
        high_priority = sum(1 for issue in list(pseudo_issues.values()) + list(model_issues.values()) 
                           if issue['ä¸¥é‡ç¨‹åº¦'] == 'é«˜')
        
        print(f"æ€»é—®é¢˜æ•°: {total_issues}")
        print(f"é«˜ä¼˜å…ˆçº§é—®é¢˜: {high_priority}")
        print(f"å»ºè®®ä¿®å¤é¡ºåº: P0 â†’ P1 â†’ P2")
        
        print("\nğŸ¯ å…³é”®ä¿®å¤ç‚¹:")
        print("1. è§£å†³å¾ªç¯å¯¼å…¥é—®é¢˜ (é˜»å¡æ€§)")
        print("2. ä¿®å¤ç‰¹å¾å¯¹é½å¤±æ•ˆ (åŠŸèƒ½æ€§)")
        print("3. å»ºç«‹è´¨é‡è¯„ä¼°æœºåˆ¶ (å¯é æ€§)")
        print("4. ç»Ÿä¸€ç»“æœæ ¼å¼å¤„ç† (ä¸€è‡´æ€§)")
        
    except Exception as e:
        print(f"âŒ åˆ†æå¤±è´¥: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main()
    
    print(f"\nğŸ’¡ ä¸‹ä¸€æ­¥è¡ŒåŠ¨:")
    print(f"  1. ä¼˜å…ˆä¿®å¤P0çº§åˆ«é—®é¢˜")
    print(f"  2. åˆ›å»ºå…·ä½“çš„ä¿®å¤è„šæœ¬")
    print(f"  3. å»ºç«‹æµ‹è¯•éªŒè¯æœºåˆ¶")
    print(f"  4. é€æ­¥å®æ–½è´¨é‡æ”¹è¿›")
